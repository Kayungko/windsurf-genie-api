## Windsurf Genie API 云服务器部署说明

> 目标：在云服务器上长期稳定运行 `windsurf-genie-api`（Node/Express 服务），并通过 1Panel + openresty 做反向代理对外提供 HTTPS 访问。

---

### 0. 前置条件

1. 云服务器已安装：
   - Linux（如 Ubuntu / Debian / CentOS）
   - 1Panel 面板（已安装 openresty 并用于反向代理）
2. 系统已安装或可以安装：
   - `git`
   - `Node.js`（建议 18+）
   - `npm`
3. 已准备好代码仓库地址，例如：
   - `https://github.com/xxx/windsurf-genie-api.git`

> 特殊说明：云服务器已安装 1Panel 面板，其他服务的反代理均通过 1Panel 面板设置好了，使用的是 openresty。

---

### 1. 连接云服务器

```bash
ssh root@64.69.40.34
```

如有自定义端口或非 root 用户，按实际情况调整：

```bash
ssh -p <port> <user>@64.69.40.34
```

---

### 2. 克隆项目到服务器

建议放到 `/opt` 或 `/srv` 目录下：

```bash
cd /opt
git clone <你的仓库地址> windsuf-genie-api
cd windsuf-genie-api
```

> 如果已经通过其他方式上传代码，只需要确保当前目录是包含 `package.json` 和 `index.js` 的项目根目录即可。

---

### 3. 安装依赖

```bash
cd /opt/windsurf-genie-api
npm install
```

如需国内加速，可自行配置 `npm config set registry`。

---

### 4. 配置环境变量

当前服务默认：
- 监听端口：`PORT`（未设置时默认 3000）

建议在服务器上设置：

```bash
export PORT=3000
```

如果使用 pm2，可以在后面使用 `ecosystem.config.js` 管理环境变量（可选，后续再补充）。

> 建议服务仅监听内网地址（如 127.0.0.1:3000），通过 1Panel/openresty 做反向代理对外暴露域名和 HTTPS。

---

### 5. 安装并配置 pm2

#### 5.1 全局安装 pm2

```bash
npm install -g pm2
```

#### 5.2 使用 pm2 启动服务

在项目根目录执行：

```bash
cd /opt/windsurf-genie-api
pm2 start index.js --name windsuf-genie-api
```

#### 5.3 设置开机自启（可选）

```bash
pm2 save
pm2 startup
# 按照命令提示执行相应的 systemd 命令
```

---

### 6. 使用 1Panel + openresty 配置反向代理

> 以下步骤在 1Panel 面板中完成，具体界面以实际版本为准，仅给出逻辑流程。

1. 登录 1Panel 后台。
2. 在网站 / 反向代理管理中：
   - 新建一个站点或反向代理条目。
   - 绑定你希望对外暴露的域名，例如：`api.example.com`。
   - 反向代理目标地址设置为：`http://127.0.0.1:3000`。
3. 如需 HTTPS：
   - 在 1Panel 中为该域名申请或上传证书。
   - 启用 HTTPS，并将流量代理到 `127.0.0.1:3000`。

完成后，外部访问流程为：

```text
客户端 → https://api.example.com → openresty(1Panel) → http://127.0.0.1:3000 (windsurf-genie-api)
```

---

### 7. 启动服务 & 验证运行状态

#### 7.1 查看 pm2 进程

```bash
pm2 ls
pm2 logs windsuf-genie-api --lines 50
```

确认进程状态为 `online`，日志中看到：

```text
Windsurf Genie API listening on port 3000
```

#### 7.2 本机验证（服务器内）

```bash
curl http://127.0.0.1:3000/random-user
curl http://127.0.0.1:3000/bin/411111
```

返回 JSON 即表示服务正常运行。

#### 7.3 外部验证（通过域名）

在本地浏览器或终端测试：

```bash
curl https://api.example.com/random-user
curl https://api.example.com/bin/411111
```

如能正常返回数据，则说明：
- Node 服务运行正常
- openresty 反向代理配置正确
- 域名 / HTTPS 配置生效